<?php
    /*--------------------------------------------------
      Socket ��ſ�û sample page
      author: 
      updated date: 2013.06.13
    --------------------------------------------------*/
    /*
     * ������ ���� ȯ�� ���� ����
     */
    include './branch_config.php';

    /*
     * ��ȣȭ/��ȣȭ ���� ���� include
     */
    include './cipher_receive.php';


    /**********************************************************************************************************************
    *
    * ���� ���� �κ�
    *
    ************************************************************************************************************************/

    //��û ���� ����
    $request_str = create_request_msg($_POST['card_num'],$_POST['birth']);

    //��ȣȭ
    $encrypted_msg = encrypt_tworld($request_str,$config['sklte_key']);

    //���� ��û
    $receive_data = send_request_action($config,$encrypted_msg);

    //��ȣȭ
    $decrypted_msg = decrypt_tworld($receive_data,$config['sklte_key']);

    //���� �м�
    $reponse_str = analysis_response_data($decrypted_msg);

    //��� ���
    foreach($reponse_str as $rval){
      echo $rval['title'].":".$rval['value']."<br>";
    }


    /**********************************************************************************************************************/


    /*
     *
     *  ���� ��û �Լ�
     *
     *
     */
    function send_request_action($config,$encrypted_msg){


          //��û ����� �ʱ�ȭ
          $result_code = '';
          /*--------------------------------------------------
            Socket Client PHP Page

            html���� �Է� ���� ���� �ڵ������� ���� �̿��Ͽ�
            ������ ������ ��û�ϴ� PHP ������ �̴�.

          --------------------------------------------------*/

          /*-------------------------------------------------
            �޽��� ����
            - html ���� �Է� ���� ���� ������ ���� �������� ����
              Data�� �����Ѵ�.
            - html �Է°�

          ... �߷� ...

          -------------------------------------------------*/
          // ���� ��û ���� ����
          $message = "0200";    // �޽��� Ÿ�� : ���ο�û ("0200");
          // ���� �ð� ����
          $trans_date = date("YmdHis"); // ���� ���� �Ͻ� : YYYYMMDDhhmmss
          // �ŷ� ��ȣ ����

          // ���ݻ���
          $price = $_POST['price'];


          //... �߷� ...

          /*-------------------------------------------------
            ���� �޽��� ȭ�� ���

          -------------------------------------------------*/
          echo "<<   �Է°�    >>    <br>";
          echo "�޽��� Ÿ��:  ".$message."<br>";
          echo "�ŷ��ݾ�:   ".$price."<br>";
          echo "���������Ͻ�:   ".$trans_date."<br>";

          //... �߷� ...

          /*-------------------------------------------------
            ���� �޽��� ����

          -------------------------------------------------*/
          $msg = $message.$price.$trans_date.     //... �߷� ...  ;

          /*-------------------------------------------------
            �޽��� ��ȣȭ

                      - Triple DES �˷θ����� �̿�
                  192bit Ű�� �����Ͽ� �޽����� ��ȣȭ �Ѵ�.

            ��)
            $key = "012345678901234567890123";
            $ encrypted_msg = encrypt($msg, $key);

          ---------------------------------------------------*/
          $encrypted_msg = $encrypted_msg; //��ȣȭ�� �޼���..
          $encrypted_msg = $config['sklte_van'].$encrypted_msg."\n";  //������ �з��ڵ带 ���Ѵ�


          /*-------------------------------------------------
            Ŭ���̾�Ʈ ���� ����
          -------------------------------------------------*/
          $fp = fsockopen($config['sk_server_ip_addr'],$config['sk_server_port'],$errno,$errstr,5);

          if(!$fp){
                // ���� ���� ���� ó��
                echo "$errstr ($errno)<br>\n";

                } else {

              /*-------------------------------------------------
                  �޽��� ����
              -------------------------------------------------*/
              $send_msg = fputs($fp, $encrypted_msg);

              /*-------------------------------------------------
                  ���� ���� �޽��� ����
              -------------------------------------------------*/
              echo "<br><br>  <<     �����   >>  <br>";
                //echo $msg = fgets($fp, 4096);
                  $receive_msg = '';
              while(!feof($fp)){
                $receive_msg .= fgets($fp, 4096);
              }

              /*-------------------------------------------------
                  �޽��� ��ȣȭ - ���� ���� ����


                - Triple DES �˷θ����� �̿�
                      192bit Ű�� �����Ͽ� �޽����� ��ȣȭ �Ѵ�.

                ��)
                $key = "123456781234567812345678";
                $ decrypted_msg = decrypt($msg, $key);

              -------------------------------------------------*/

              //echo "<br><br>";

              /*-------------------------------------------------
                ���� �޽��� ó��
                - ���� �޽������� �ش� �׸��� �̾� ������ �Ҵ��Ѵ�.
              --------------------------------------------------*/

              //$message  = $msg.substr(0,4);
              //$price    = $msg.substr(4,12);
              //$trans_date = $msg.substr(16,14);

              //... �߷� ...

              /*-------------------------------------------------
                ���� �޽��� ȭ�� ���

              -------------------------------------------------*/
              //echo "<<   ���Ű�    >>    <br>";
              //echo "�޽��� Ÿ��:  ".$message."<br>";
              //echo "�ŷ��ݾ�:   ".$price."<br>";
              //echo "���������Ͻ�:   ".$trans_date."<br>";

              //... �߷� ...



              /*-------------------------------------------------
                ���� ��� ó��
                - ���� ��� ���� �ڵ� �� "00" �� ��� ����, ���� �����
                  ������ ��� ���� Data ��ü ������ �ʿ���
                  ������ ��� ���� �ڵ� �� �޽��� ó��
                  (�ŷ� ���� �� �ŷ����� ��ǥ ����)
              -------------------------------------------------*/
              //if ($result_code == "00") {
              //  echo "���εǾ����ϴ�.";
              //}
              //else {
              //  echo "������ �����Ǿ����ϴ�. �����ڵ� : ".$result_code;
              //}
          }

          /*-------------------------------------------------
            ���� �ݱ�
          -------------------------------------------------*/
          fclose($fp);

          /*-------------------------------------------------
            ����� ����
          -------------------------------------------------*/
          return $receive_msg;

    }

?>